{% extends "trs/base.html" %}
{% load trs_formatting %}

{% block main-column %}
  <h1>
    {{ view.project.code }}
    {% if view.project.archived %}
      <span title="Project is gearchiveerd"
            class="text-muted glyphicon glyphicon-lock"></span>
    {% endif %}
    {% if project.is_accepted %}
      <span title="Project is afgekaart"
            class="text-muted glyphicon glyphicon-ok"></span>
    {% endif %}
    {% if project.is_subsidized %}
      <span title="Subsidieproject"
            class="text-muted glyphicon glyphicon-usd"></span>
    {% endif %}
    {% if view.project.hidden %}
      <span title="Afgeschermd project: je ziet elkaars uren niet"
            class="text-muted glyphicon glyphicon-ban-circle"></span>
    {% endif %}
    {% if view.project.hourless %}
      <span title="Uren tellen niet mee voor totaal"
            class="text-muted glyphicon glyphicon-picture"></span>
    {% endif %}
    <small>{{ view.project.description }}</small>
  </h1>
  <table class="table borderless-table table-condensed"
         style="width: auto;">
    <tbody>
      <tr>
        <th>Opdrachtgever</th>
        <td>{{ view.project.principal }}</td>
      </tr>
      <tr>
        <th>Opdrachtsom</th>
        <td>{{ view.project.contract_amount|money }}</td>
      </tr>
      <tr>
        <th>Startweek</th>
        <td>{{ view.project.start.friendly|default:"Niet ingevuld" }}</td>
      </tr>
      <tr>
        <th>Laatste week</th>
        <td>{{ view.project.end.friendly|default:"Niet ingevuld" }}</td>
      </tr>
      <tr>
        <th>Afgekaart</th>
        <td>
          {% if view.project.is_accepted %}
            Het project is afgekaart door PL en PM. In principe worth er nu
            niets meer veranderd aan teamsamenstelling, uurtarief en
            urenverdeling.
          {% else %}
            Het project is nog niet afgekaart door PL en PM. Urenverdeling,
            uurtarief en teamsamenstelling kunnen allemaal nog veranderd worden.
          {% endif %}
        </td>
      </tr>
      {% if view.project.remark %}
        <tr>
          <th>Opmerkingen</th>
          <td>{{ view.project.remark|linebreaksbr }}</td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  {% if view.can_edit_project %}
    <p>
      <a href="{% url 'trs.project.edit' pk=view.project.pk %}"
         class="btn btn-default">
        <span class="glyphicon glyphicon-pencil"></span>
        Project bewerken
      </a>
    </p>
  {% endif %}

  {% if view.can_view_team %}
    <h2>Projectteam</h2>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Wie</th>
            <th></th>
            <th class="text-right">Toegekend</th>
            <th class="text-right">Geboekt</th>
            {% if view.can_see_financials %}
              <th class="text-right">Tarief</th>
              <th class="text-right">Omzet</th>
              <th class="text-right">Verlies</th>
            {% endif %}
          </tr>
        </thead>

        <tbody>
          {% for line in view.lines %}
            <tr>
              <td>
                {{ line.person.as_widget }}
                {% if view.can_see_financials %}
                  {% if line.person.to_book.friendly %}
                    <span class="badge"
                          title="Achter met boeken: {{ line.person.to_book.friendly }}">
                      {{ line.person.to_book.short }}
                    <span>
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {% if line.is_project_leader %}
                  <span title="Projectleider: gaat over de uren">PL</span>
                  &nbsp;
                {% endif %}
                {% if line.is_project_manager %}
                  <span title="Projectmanager: gaat over de financi&euml;n">PM</span>
                {% endif %}
              </td>
              <td class="text-right">{{ line.budget|hours }}</td>
              <td class="text-right
                         {% if line.is_overbooked %}danger{% endif %}">
                {{ line.booked|hours }}
              </td>
              {% if view.can_see_financials %}
                {% if line.hourly_tariff >= line.desired_hourly_tariff %}
                  <td class="text-right">
                    {{ line.hourly_tariff|money }}
                  </td>
                {% else %}
                  <td class="text-right danger">
                    <span title="Gewenst: {{ line.desired_hourly_tariff }}.">
                      {{ line.hourly_tariff|money }}
                    </span>
                  </td>
                {% endif %}
                <td class="text-right">{{ line.turnover|money }}</td>
                <td class="text-right">{{ line.loss|money }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>

        {% if view.can_see_financials %}
          <tfoot>
            <tr>
              <th>Totaal</th>
              <td></td>
              <td class="text-right"></td>
              <td class="text-right"></td>
              <td class="text-right"></td>
              <th class="text-right">{{ view.total_turnover|money }}</th>
              <th class="text-right">{{ view.total_loss|money }}</th>
            </tr>
          </tfoot>
        {% endif %}
      </table>

      {% if view.can_edit_team %}
        <div>
          <a href="{% url 'trs.project.team' pk=view.project.pk %}"
             class="btn btn-default">
            <span class="glyphicon glyphicon-pencil"></span>
            Pas team aan
          </a>
        </div>
      {% endif %}
    </div>
  {% else %}
    <p>
      <span class="glyphicon glyphicon-warning-sign text-danger"></span>
      Dit project is afgeschermd, dus je kan niet zien wie er op dit project
      mogen boeken.
    </p>
  {% endif %}

  {% if view.can_see_project_financials %}
    <h2>Begroting</h2>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Beschrijving</th>
            <th>Reservering?</th>
            <th class="text-right">Bedrag</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Opdrachtsom</td>
            <td></td>
            <td class="text-right">{{ view.project.contract_amount|money }}</td>
          </tr>
          {% for budget_item in view.project.budget_items.all %}
            <tr>
              <td>
                {% if view.can_edit_financials %}
                  <a href="{% url 'trs.budget_item.edit' project_pk=view.project.pk pk=budget_item.pk %}">
                    {{ budget_item.description }}
                  </a>
                {% else %}
                  {{ budget_item.description }}
                {% endif %}
              </td>
              <td>
                {% if budget_item.is_reservation %}
                  <span class="text-muted glyphicon glyphicon-ok"></span>
                {% endif %}
              </td>
              <td class="text-right">{{ budget_item.amount|money }}</td>
            </tr>
          {% endfor %}
          <tr>
            <td>Personele kosten</td>
            <td></td>
            <td class="text-right">{{ view.person_costs|money }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th>Totaal</th>
            <th></th>
            {% if view.total %}
              <th class="text-right danger"
                  title="Moet op 0 uitkomen">
                {{ view.total|money }}
              </th>
            {% else %}
              <th class="text-right">
                {{ view.total|money }}
              </th>
            {% endif %}
          </tr>
        </tfoot>
      </table>
    </div>

    {% if view.can_edit_financials %}
      <div>
        <a href="{% url 'trs.budget_item.add' project_pk=view.project.pk %}"
           class="btn btn-default">
          <span class="glyphicon glyphicon-plus"></span>
          Voeg begrotingsitem toe
        </a>
      </div>
    {% endif %}

    <h2>Facturen</h2>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Factuurnummer</th>
            <th>Omschrijving</th>
            <th class="text-right">Exclusief</th>
            <th class="text-right">BTW</th>
            <th class="text-right">Inclusief</th>
            <th>Betaald</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in view.project.invoices.all %}
            <tr>
              <td>{{ invoice.date }}</td>
              <td>
                {% if view.can_edit_financials %}
                  <a href="{% url 'trs.invoice.edit' project_pk=view.project.pk pk=invoice.pk %}">
                    {{ invoice.number }}
                  </a>
                {% else %}
                  {{ invoice.number }}
                {% endif %}
              </td>
              <td>{{ invoice.description }}</td>
              <td class="text-right">{{ invoice.amount_exclusive|money }}</td>
              <td class="text-right">{{ invoice.vat|money }}</td>
              <td class="text-right">{{ invoice.amount_inclusive|money }}</td>
              <td>{{ invoice.payed|default:'Nee' }}</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th>Totaal</th>
            <th></th>
            <th></th>
            <th class="text-right">{{ view.total_invoice_exclusive|money }}</th>
            <th></th>
            <th class="text-right">{{ view.total_invoice_inclusive|money }}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>

    {% if view.can_edit_financials %}
      <div>
        <a href="{% url 'trs.invoice.add' project_pk=view.project.pk %}"
           class="btn btn-default">
          <span class="glyphicon glyphicon-plus"></span>
          Voeg factuur toe
        </a>
      </div>
    {% endif %}

  {% endif %}

{% endblock %}
