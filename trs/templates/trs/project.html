{% extends "trs/base.html" %}
{% load trs_formatting %}

{% block full-width %}
  <h1>
    {{ view.project.code }}
    {% if view.project.archived %}
      <span title="Project is gearchiveerd"
            class="text-muted glyphicon glyphicon-lock"></span>
    {% endif %}
    {% if view.project.is_subsidized %}
      <span title="Subsidieproject"
            class="text-muted glyphicon glyphicon-usd"></span>
    {% endif %}
    {% if view.project.hidden %}
      <span title="Afgeschermd project: je ziet elkaars uren niet"
            class="text-muted glyphicon glyphicon-ban-circle"></span>
    {% endif %}
    {% if view.project.hourless %}
      <span title="Uren tellen niet mee voor totaal"
            class="text-muted glyphicon glyphicon-picture"></span>
    {% endif %}
    <small>{{ view.project.description }}</small>
    {% if view.can_see_project_financials %}
      <a class="pull-right"
         title="Download .csv"
         href="{% url 'trs.project.csv' pk=view.project.id %}">
        <span class="glyphicon glyphicon-download-alt"></span>
      </a>
    {% endif %}
  </h1>

  {# We use the full-width block, so we miss the regular messages part. #}
  {# So we need to add it ourselves. #}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissable">
      <button type="button"
              class="close"
              data-dismiss="alert"
              aria-hidden="true">&times;</button>
      {{ message }}
    </div>
  {% endfor %}

  <table class="table borderless-table table-condensed"
         style="width: auto;">
    <tbody>
      <tr>
        <th>Opdrachtgever</th>
        <td>{{ view.project.principal }}</td>
      </tr>
      <tr>
        <th>Opdrachtsom</th>
        <td>
          {{ view.project.contract_amount|money }}
        </td>
      </tr>
      {% if view.project.group %}
        <tr>
          <th>Groep</th>
          <td>{{ view.project.group }}</td>
        </tr>
      {% endif %}
      <tr>
        <th>Startweek</th>
        <td>{{ view.project.start.friendly|default:"Niet ingevuld" }}</td>
      </tr>
      <tr>
        <th>Laatste week</th>
        <td>{{ view.project.end.friendly|default:"Niet ingevuld" }}</td>
      </tr>
      <tr>
        <th>Startoverleg</th>
        <td>
          {% if view.project.startup_meeting_done %}
            <span class="glyphicon glyphicon-ok"></span>
            Het startoverleg heeft plaatsgevonden
          {% else %}
            <span class="glyphicon glyphicon-remove"></span>
          {% endif %}
        </td>
      </tr>
      <tr>
        <th>Goedgekeurd</th>
        <td>
          {% if view.project.is_accepted %}
            <span class="text-success glyphicon glyphicon-ok"></span>
            Het project is goedgekeurd door de PM.
          {% else %}
            <span class="glyphicon glyphicon-remove"></span>
          {% endif %}
        </td>
      </tr>
      {% if view.project.remark %}
        <tr>
          <th>Opmerkingen</th>
          <td>{{ view.project.remark|linebreaksbr }}</td>
        </tr>
      {% endif %}
      {% if view.project.financial_remark %}
        <tr>
          <th>Financiële opmerkingen</th>
          <td>{{ view.project.financial_remark|linebreaksbr }}</td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  {% if view.can_edit_project %}
    <p>
      <a href="{% url 'trs.project.edit' pk=view.project.pk %}"
         class="btn btn-default">
        <span class="glyphicon glyphicon-pencil"></span>
        Project bewerken
      </a>
    </p>
  {% endif %}

  {% if view.can_view_team %}
    {% if not view.can_see_project_financials %}
      <h2>Projectteam</h2>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th></th>
              <th></th>
              <th class="text-right">Toegekend</th>
              <th class="text-right">&nbsp;&nbsp;&nbsp;</th>
              <th class="text-right">Geboekt</th>
            </tr>
          </thead>

          <tbody>
            {% for line in view.lines %}
              <tr>
                <td>
                  {{ line.person.as_widget }}
                </td>
                <td>
                  {% if line.is_project_leader %}
                    <span title="Projectleider: gaat over de uren">PL</span>
                    &nbsp;
                  {% endif %}
                  {% if line.is_project_manager %}
                    <span title="Projectmanager: gaat over de financi&euml;n">PM</span>
                  {% endif %}
                </td>
                <td class="text-right">{{ line.budget|hours }}</td>
                <td class="text-right">&nbsp;&nbsp;&nbsp;</td>
                <td class="text-right
                           {% if line.is_overbooked %}danger{% endif %}">
                  {{ line.booked|hours }}
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>

    {% endif %}
    {% if view.can_see_project_financials %}

      <h2 id="budget">
        Projectbegroting
        {% if not view.project.budget_ok %}
          <span class="text-danger glyphicon glyphicon-warning-sign"
                title="Budget is niet goed verdeeld"></span>
        {% endif %}
      </h2>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th></th>
              <th></th>
              <th class="text-right">Kosten</th>
              <th class="text-right">Inkomsten</th>
              <th colspan="5"></th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <th>Opdrachtsom</th>
              <td class="text-right"
                  colspan="3">
                {{ view.project.contract_amount|money }}
              <td colspan="3"></td>
              </td>
            </tr>
          </tbody

          <tbody>
            <tr>
              <th>Personele kosten</th>
              <th colspan="3"></th>
              <th class="text-right">Toegekend</th>
              <th class="text-right">Geboekt</th>
              <th class="text-right">Tarief</th>
              <th class="text-right">Omzet</th>
              <th class="text-right">Verlies</th>
            </tr>

            {% for line in view.lines %}
              <tr>
                <td>
                  &nbsp;&nbsp;&nbsp;
                  {{ line.person.as_widget }}
                </td>
                <td>
                  {% if line.person.to_book.friendly %}
                    <span class="badge"
                          title="Achter met boeken: {{ line.person.to_book.friendly }}">
                      {{ line.person.to_book.short }}
                    </span>
                  {% endif %}
                  {% if line.is_project_leader %}
                    <span title="Projectleider: gaat over de uren">PL</span>
                    &nbsp;
                  {% endif %}
                  {% if line.is_project_manager %}
                    <span title="Projectmanager: gaat over de financi&euml;n">PM</span>
                  {% endif %}
                </td>

                <td class="text-right">
                  {{ line.planned_turnover|money }}
                </td>
                <td class="text-right">
                  &nbsp;  {# costs #}
                </td>

                <td class="text-right">{{ line.budget|hours }}</td>
                <td class="text-right
                           {% if line.is_overbooked %}danger{% endif %}">
                  {{ line.booked|hours }}
                </td>
                {% if line.hourly_tariff >= line.desired_hourly_tariff %}
                  <td class="text-right">
                    {{ line.hourly_tariff|money }}
                  </td>
                {% else %}
                  <td class="text-right danger">
                    <span title="Gewenst: {{ line.desired_hourly_tariff }}.">
                      {{ line.hourly_tariff|money }}
                    </span>
                  </td>
                {% endif %}
                <td class="text-right">{{ line.turnover|money }}</td>
                <td class="text-right">{{ line.loss|money }}</td>
              </tr>
            {% endfor %}
            {% if view.can_see_project_financials %}
              <tr>
                <td>&nbsp;&nbsp;&nbsp;Reservering</td>
                <td class="text-right"
                    colspan="2">
                  {{ view.project.reservation|money }}
                <td colspan="6"></td>
              </tr>

              <tr>
                <th>
                  {# Subtotaal #}
                </th>
                <td class="text-right"></td>
                <th class="text-right">{{ view.person_costs_incl_reservation|money }}</th>
                <td class="text-right">{# costs #}</td>
                <td colspan="2"></td>
                <td class="text-right"></td>
                <th class="text-right">{{ view.total_turnover|money }}</th>
                <th class="text-right">{{ view.total_loss|money }}</th>
              </tr>
            {% endif %}
          </tbody>

          {% if view.can_see_project_financials %}
            <tbody>
              <tr>
                <th>Overige kosten</th>
                <td colspan="7"></td>
              </tr>
              {% for budget_item in view.project.budget_items.all %}
                <tr>
                  <td>
                    &nbsp;&nbsp;&nbsp;
                    {% if view.can_edit_financials %}
                      <a href="{% url 'trs.budget_item.edit' project_pk=view.project.pk pk=budget_item.pk %}">
                        {{ budget_item.description }}
                      </a>
                    {% else %}
                      {{ budget_item.description }}
                    {% endif %}
                    {% if budget_item.to_project %}
                      naar {{ budget_item.to_project.as_widget }}
                    {% endif %}
                  </td>
                  <td>
                    {% if view.can_edit_financials %}
                      <a href="{% url 'trs.project.budget-item-delete' pk=view.project.pk budget_item_pk=budget_item.pk %}">
                        <span class="glyphicon glyphicon-minus-sign text-danger"></span>
                      </a>
                    {% endif %}
                  </td>
                  {% if budget_item.amount > 0 %}
                    <td class="text-right">{{ budget_item.amount|money }}</td>
                    <td class="text-right"></td>
                  {% else %}
                    <td class="text-right"></td>
                    <td class="text-right">{{ budget_item.amount_as_income|money }}</td>
                  {% endif %}
                  <td colspan="5">
                    {% if budget_item.is_third_party_cost %}
                      <span class="text-muted">kosten derden</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}

              {% for budget_item in view.project.budget_transfers.all %}
                <tr>
                  <td>
                    &nbsp;&nbsp;&nbsp;
                    {{ budget_item.description }}
                    van {{ budget_item.project.as_widget }}
                  </td>
                  <td>
                  </td>
                  {% if budget_item.amount < 0 %}
                    <td class="text-right">{{ budget_item.amount_as_income|money }}</td>
                    <td class="text-right"></td>
                  {% else %}
                    <td class="text-right"></td>
                    <td class="text-right">{{ budget_item.amount|money }}</td>
                  {% endif %}
                  <td colspan="5">
                  </td>
                </tr>
              {% endfor %}

            </tbody>
            <tfoot>
              <tr>
                <th>Totaal</th>
                <th></th>
                <th class="text-right">
                  {{ view.total_costs|money }}
                </th>
                <th class="text-right">
                  {{ view.total_income|money }}
                </th>
                <th colspan="4"></th>
              </tr>
              <tr>
                <th>Nog te verdelen</th>
                <th colspan="2"></th>
                <th class="text-right">
                  {{ view.project.left_to_dish_out|money }}
                </th>
                <th colspan="4"></th>
              </tr>
            </tfoot>
          {% endif %}

        </table>
      </div>

    {% endif %}



    <div>
      {% if view.can_edit_team %}
        <a href="{% url 'trs.project.team' pk=view.project.pk %}"
           class="btn btn-default">
          <span class="glyphicon glyphicon-pencil"></span>
          Pas personele kosten aan
        </a>
        &nbsp;&nbsp;
      {% endif %}
      {% if view.can_edit_financials %}
        <a href="{% url 'trs.budget_item.add' project_pk=view.project.pk %}"
           class="btn btn-default">
          <span class="glyphicon glyphicon-plus"></span>
          Voeg kostenpost toe
        </a>
      {% endif %}
    </div>
    {% if view.can_edit_and_see_everything and view.project.internal %}
      <p class="text-muted">
        Indien iedereen aan dit interne project toegevoegd moet worden:
        <a href="{% url 'trs.project.update-team' pk=view.project.pk %}">
          update het team automatisch
        </a>.
      </p>
    {% endif %}

  {% else %}
    <p>
      <span class="glyphicon glyphicon-warning-sign text-danger"></span>
      Dit project is afgeschermd, dus je kan niet zien wie er op dit project
      mogen boeken.
    </p>
  {% endif %}

  {% if view.can_see_project_financials %}
    <h2>Facturen</h2>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Factuurnummer</th>
            <th></th>
            <th>Omschrijving</th>
            <th class="text-right">Exclusief</th>
            <th class="text-right">BTW</th>
            <th class="text-right">Inclusief</th>
            <th>Betaald</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in view.project.invoices.all %}
            <tr>
              <td>{{ invoice.date|date:"j b Y" }}</td>
              <td>
                {% if view.can_edit_financials %}
                  <a href="{% url 'trs.invoice.edit' project_pk=view.project.pk pk=invoice.pk %}">
                    {{ invoice.number }}
                  </a>
                {% else %}
                  {{ invoice.number }}
                {% endif %}
              </td>
              <td>
                {% if view.can_edit_financials %}
                  <a href="{% url 'trs.project.invoice-delete' pk=view.project.pk invoice_pk=invoice.pk %}">
                    <span class="glyphicon glyphicon-minus-sign text-danger"></span>
                  </a>
                {% endif %}
              </td>
              <td>{{ invoice.description }}</td>
              <td class="text-right">{{ invoice.amount_exclusive|money_with_decimal }}</td>
              <td class="text-right">{{ invoice.vat|money_with_decimal }}</td>
              <td class="text-right">{{ invoice.amount_inclusive|money_with_decimal }}</td>
              <td>{{ invoice.payed|date:"j b Y"|default:'Nee' }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8">
                <i>Er zijn geen facturen toegevoegd.</i>
              </td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th>Totaal</th>
            <th></th>
            <th></th>
            <th></th>
            <th class="text-right">{{ view.total_invoice_exclusive|money_with_decimal }}</th>
            <th></th>
            <th class="text-right">{{ view.total_invoice_inclusive|money_with_decimal }}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>

    {% if view.can_edit_project_financials %}
      <div>
        <a href="{% url 'trs.invoice.add' project_pk=view.project.pk %}"
           class="btn btn-default">
          <span class="glyphicon glyphicon-plus"></span>
          Voeg factuur toe
        </a>
      </div>
    {% endif %}

    {% if view.project.financial_remark %}
      <p>
        <b>Financiële opmerkingen:</b><br>
        {{ view.project.financial_remark|linebreaksbr }}
      </p>
    {% endif %}

  {% endif %}

{% endblock %}
